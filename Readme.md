## Dependencies

### ios

Dependency to XCFramework, created through `updateIosFramework` npm script.
Note that this requires the `icure-multiplatform-sdk` submodule to be initialised.

### android

For development we can use builds of kryptom published to maven local. For some reason we have to add maven local in
the `example/android/build.gradle` file... It seems like it is not necessary to add it to the `android/build.gradle` 
file for development, however, if in future we use a non-maven-central repository for the publishing of our artifacts
we may need to add the repository configuration also there.

## Editing

### Android

First make sure you published kryptom to mavenlocal or use a publicly published version.

Intellij idea does not work very well for editing the android module, android studio works better. To open the project in android studio use 

```bash
npm run open:android
```

### Ios

First initialise the icure-multiplatform-sdk submodule

```bash
git submodule update
```

then create the XCFramework using

```bash
npm run updateIosFramework
```

To open the project in xcode you can use the following commands:

```bash
npm run open:ios
```

In XCode you can navigate to the swift code of the native module through `Pods/Development Pods/ExpoKryptom`

To get syntax higlighting for the framework-provided functions you may need to first run the app once, in order to properly setup the environment.

#### Update the xcframework a second time

If you want to update the xcframework after you have already installed the pods  you will need to do a full pod reinstall, otherwise due to some caching the application will continue to still use the old xcframework. You can do this by running the following commands:

```bash
cd example/ios
rm -rf ~/Library/Caches/CocoaPods
rm -rf Pods
rm -rf ~/Library/Developer/Xcode/DerivedData/*
pod deintegrate
pod setup
pod install
```

## Notes about framework

It was a lot of pain to figure out how to properly include the framework in the podspec, for future reference here are some notes that should help in case we have to do it again.

### Naming

- The framework name must start with an uppercase, otherwise some tools will misbehave. 

- On kotlin multiplatform make sure to configure the same name for the XCFramework and for all the targets. For example in the `build.gradle.kts`
	```kotlin
	val frameworkName = "Kryptom"// or project.name.replaceFirstChar { it.uppercase() }
	val xcf = XCFramework(frameworkName)
	//[...]
		val iosSimulators = listOf(
		iosX64(),
		iosSimulatorArm64()
	)
	val iosAll = iosSimulators + iosArm64()
	iosAll.forEach { target ->
		target.binaries.framework {
			baseName = frameworkName
			xcf.add(this)
		}
	}
	```

### Building the framework on kotlin Multiplatform

You can build the framework with the `assemble[FrameworkName]XCFramework` task, for example to build the kryptom framework from the multiplatform sdk:

```bash
./gradlew :kryptom:assembleKryptomXCFramework   
```

The framework will be in `build/XCFrameworks`. Currently we are providing only the release framework since there is no easy way of providing them both from a cocoapod.

### Podspec with vendored framework - error with `.h` files

The default podspec generated by the `create-expo-module` utility has some issues when used with vendored frameworks.

After adding the xcframework produced by kotlin multiplatform as a dependency through for example:

```podspec
Pod::Spec.new do |s|
  # [...]
  s.vendored_frameworks = 'Frameworks/Kryptom.xcframework'
  # [...]
```

Make sure that the files inside the framework are NOT included as sources of the pod. The default configuration includes a line:

```podspec
Pod::Spec.new do |s|
  # [...]
  s.source_files = "**/*.{h,m,swift}"
```

which causes the files 
- `ios/Frameworks/Kryptom.xcframework/ios-arm64_x86_64-simulator/Kryptom.framework/Headers/Kryptom.h`
- `ios/Frameworks/Kryptom.xcframework/ios-arm64/Kryptom.framework/Headers/Kryptom.h`

to be included in the build, which causes a few problems because they have the same name and they are not public headers.

In this case we could fix the issue simply by replacing `s.source_files = "**/*.{h,m,swift}"` with `s.source_files = "**/*.swift"`. If in future we need to include some `.h` files we can either exclude the `Frameworks` directory from the source files or move the source files in a `src` subdirectory.


## Running the example app

Before running the app make sure to install the node dependencies under the example app.

```bash
cd example
npm install
```

And that you initialised the git submodule

```bash
git submodule update
```

### Android

Publish to maven local kryptom:

```bash
cd icure-multiplatform-sdk
./gradlew :kryptom:publishToMavenLocal
```

Find the version that you have published

```
ls ~/.m2/repository/com/icure/kryptom
```

And update the version in the `android/build.gradle` file if needed.

Then run the following commands

```bash
npm run build
```
```bash
cd example
npx expo run:android
```

### ios

Build the kryptom framework

```
npm run updateIosFramework
```

Then run

```bash
npm run build
```
```bash
cd example
npx expo run:ios
```